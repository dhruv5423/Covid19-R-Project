---
title: "Toronto's Covid-19 Impact: Effect of Age and Gender on Outcomes"
author: 
  - Dhruv Gupta
thanks: "Code and data are available at: https://github.com/dhruv5423/Covid19-R-Project"
date: "today"
date-format: long
abstract: "The Covid-19 Pandemic caused irreparable damage to the infrastructure of our global systems, highlighting the neccessity to better understand factors that influence health outcomes. This paper uses data from OpenDataToronto to investigate how age and gender affects outcomes of those infected with the virus. xyz about results"
format: pdf
toc: true
number-sections: true
bibliography: references.bib
header-includes:
  - \usepackage{float}
---

```{r}
#| include: false
#| warning: false
#| message: false

#Loading Packages
library(pander)
library(tidyverse)
library(here)
library(palmerpenguins)
library(opendatatoronto)
library(tinytex)
library(knitr)
library(kableExtra)

#Loading Data
raw_covid_data <- read.csv(here("data/raw_data/raw_covid_data.csv"))
cleaned_covid_data <- read.csv(here("data/analysis_data/cleaned_covid_data.csv"))
```

\newpage

# Introduction

The Covid-19 Pandemic has had an unimaginable effect on human lives around the globe. As of April 13, 2024, Worldometer Info estimates that over 704 million people worldwide have contracted the virus, resulting in approximately 7 million deaths [@worldometer]. In Canada alone, there have been almost 4.6 million reported cases and more than 38,000 deaths as of July 20, 2024 [@infobase_ca].

While these statistics paint a harrowing picture of the human toll inflicted, the pandemic has exacerbated existing economic inequalities, destabilized political systems, and put immense pressure on societal infrastructure globally. Looking past the immediate health crisis, lockdowns and restrictions have had immeasurable impacts not only on global supply chains, but also on the mental heatlh of many forced to quarantine or self isolate.

An article by Fortune valued the economic burden on the US Economy to be upwards of \$14 Trillion USD at the end of 2023 [@fortune]. While this figure mainly took into account the 'standard economic effects' of the pandemic - revenue lost due to mandatory business closures, decreases in air travel, and workplace absences - the article noted that there were many unobservable factors that were incredibly burdernsome to the economy, such as long term physical and mental health effects of the pandemic on the population.

Covid-19 has been found to have varying effects across demographics. A 2020 article published in the PLOS Journal found that 'Covid-19 may be associated with worse outcomes in males than in females'. The article found that men are up to 22% more likely to require ICU admission.

Moreover, an article published in the Springer Link Journal in 2021 found that older adults, in particular those above the age of 65, face higher mortality rates than their younger counterparts. Weaker immune systems, and the higher likely presence of other conditions can exacerbate the effects of the virus.

Understanding how demographic variables like age and gender affect outcomes related to contracting viruses is increasingly important in the shaping of future policies and health measures. This paper aims to analyse the differences in outcomes for various age groups and genders among Covid-19 cases in Toronto, in an effort to contribute to deepening our understanding of the risk factors that may impact the lives of those with Covid-19, and possibly in future pandemics as well.

The remainder of this paper is structured as follows. @sec-data discusses @sec-results xyz @sec-discussion xyz.

\newpage

# Data {#sec-data}

We use @citeR and @rohan.

## Data Selection

Data used in this report was sourced from OpenDataToronto's portal. @opendatatoronto. More specifically, the dataset "Covid-19 Cases in Toronto" was used and cleaned for the purposes of this report. Toronto Public Health (TPH) released anonymized, person-level data from the start of the pandemic in January 2020. The data spans from the first reported case on in January of 2020 to February 14th, 2024. In a statement on the website for this dataset, OpenDataToronto states that "As case and outbreak management guidelines changed and COVID-19 specific resources were no longer funded, the level of detail available for cases decreased, and more recent data are less complete and not comparable to previous years. TPH discontinued the production of this report with the final refresh as of February 14, 2024" @opendatatoronto_set

## Raw Data

In it's original form, the dataset contains more than 414,000 entries regarding information on cases of Covid-19 in Toronto. Below are two tables with the first three rwos of the raw data, separated into two tables for readability.

```{r}
#| label: tbl-raw1
#| tbl-cap: "COVID-19 Case Raw Data"
#| echo: false
#| warning: false
#| message: false

library(kableExtra)

# First part of Table 1 (first few columns)
raw_covid_data %>%
  select(X_id, Outbreak.Associated, Assigned_ID, Age.Group, Neighbourhood.Name, FSA, Source.of.Infection, Classification) %>%
  head(3) %>%
  knitr::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)

```

```{r}
#| label: tbl-raw2
#| tbl-cap: "COVID-19 Case Raw Data Part 2"
#| echo: false
#| warning: false
#| message: false

# Second part of Table 1 (next set of columns)
raw_covid_data %>%
  select(Episode.Date, Reported.Date, Client.Gender, Outcome, Ever.Hospitalized, Ever.in.ICU, Ever.Intubated) %>%
  head(3) %>%
  knitr::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)

```

(Table Separated using Tips from [@stack_tip] and LLMs)

## Data Cleaning

\scriptsize
```{r}
#| label: tbl-clean
#| tbl-cap: "COVID-19 Case Cleaned Data Part 2"
#| echo: false
#| warning: false
#| message: false
#| 
# Cleaned Data Table (Table 2)
cleaned_covid_data %>%
  head(5) %>%
  kable(col.names = c("x_id", "age_group", "client_gender", "reported_date", "ever_in_icu", "ever_hospitalized", "ever_intubated", "outcome"),
        booktabs = TRUE)
```
\normalsize

## A Note on Measurement

-   gold data quality
-   updates on funding/measurement changes + discontinuation
-   likely many unreported cases

\newpage

# Results {#sec-results}

## General Results

@fig-cumulativecases displays the progression of COVID-19 cases in Toronto from January 2020 to March 2024. @fig-treatmentoutcomes importantly highlights mortality rates by level of hospitalisation. That is, the mortality rates for those hospitalised, put in the ICU, and/or intubated.

```{r}
#| label: fig-cumulativecases
#| fig-cap: "COVID-19 Case Progression Over Time, Toronto"
#| fig.width: 5
#| fig.height: 2.75
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"

# Load necessary libraries
library(ggplot2)
library(dplyr)

# Step 1: Ensure reported_date is in Date format
cleaned_covid_data$reported_date <- as.Date(cleaned_covid_data$reported_date)

# Step 3: Plot cumulative cases over time
ggplot(cleaned_covid_data, aes(x = reported_date, y = x_id)) +
  geom_line(color = "blue", size = 1) +
  labs(title = "COVID-19 Cases Over Time, Toronto",
       x = "Date",
       y = "COVID-19 Cases") +
  theme(
    plot.title = element_text(size = 12),        # Reduce the title font size
    axis.title.x = element_text(size = 10),      # Reduce the x-axis title font size
    axis.title.y = element_text(size = 10),      # Reduce the y-axis title font size
    axis.text.x = element_text(size = 8),        # Reduce the x-axis text (labels) font size
    axis.text.y = element_text(size = 8),        # Reduce the y-axis text (labels) font size
  ) +
  scale_x_date(limits = as.Date(c("2020-01-01", "2024-03-31")))

```

```{r}
#| label: fig-treatmentoutcomes
#| fig-cap: "Level of Hospitalisation vs Mortality Rates"
#| fig.width: 5
#| fig.height: 2.75
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"

# Step 1: Calculate mortality rate for intubated, hospitalized, and ICU patients
# Create a summary table with mortality rates

calc_mortality_rate <- function(df, condition_col) {
  total_patients <- nrow(df %>% filter(!!sym(condition_col) == "Yes"))
  fatal_patients <- nrow(df %>% filter(!!sym(condition_col) == "Yes" & outcome == "FATAL"))
  if (total_patients > 0) {
    return(fatal_patients / total_patients * 100)  # Return mortality rate as percentage
  } else {
    return(NA)  # Return NA if no patients in the group
  }
}

# Apply the function for each group
hospitalised_mortality_data <- data.frame(
  Condition = c("Intubated", "Hospitalized", "ICU"),
  Mortality_Rate = c(
    calc_mortality_rate(cleaned_covid_data, "ever_intubated"),
    calc_mortality_rate(cleaned_covid_data, "ever_hospitalized"),
    calc_mortality_rate(cleaned_covid_data, "ever_in_icu")
  )
)

# Step 2: Plot the mortality rate as a bar graph
ggplot(hospitalised_mortality_data, aes(x = Condition, y = Mortality_Rate)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Mortality by Condition (Intubated, Hospitalized, ICU)",
       x = "Condition",
       y = "Mortality Rate (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),        # Reduce the title font size
    axis.title.x = element_text(size = 10),      # Reduce the x-axis title font size
    axis.title.y = element_text(size = 10),      # Reduce the y-axis title font size
    axis.text.x = element_text(size = 8),        # Reduce the x-axis text (labels) font size
    axis.text.y = element_text(size = 8),        # Reduce the y-axis text (labels) font size
  ) +
  ylim(0, 100)  # Set y-axis limits to 0-100 for percentage

```

## Age vs Outcomes

@fig-agegroupmortality shows the differences in mortality rates for different age groups at the time of contracting COVID-19. @fig-agegrouphospitalisation shows the hospitalisation, ICU, or intubation rates for different age groups. 
```{r}
#| label: fig-agegroupmortality
#| fig-cap: "Age Group vs Mortality Rates"
#| fig.width: 5
#| fig.height: 3
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"

# Step 1: Define the calc_mortality_rate function for age group
calc_mortality_rate_age <- function(df, age_group_col) {
  total_patients <- nrow(df %>% filter(!!sym(age_group_col) != ""))
  fatal_patients <- nrow(df %>% filter(!!sym(age_group_col) != "" & outcome == "FATAL"))
  if (total_patients > 0) {
    return(fatal_patients / total_patients * 100)  # Return mortality rate as percentage
  } else {
    return(NA)  # Return NA if no patients in the group
  }
}

# Step 2: Calculate mortality rate for each age group
age_groups <- c("19 and younger", "20 to 29 Years", "30 to 39 Years", 
                "40 to 49 Years", "50 to 59 Years", "60 to 69 Years", 
                "70 to 79 Years", "80 to 89 Years", "90 and older")

mortality_by_age_group <- data.frame(
  Age_Group = age_groups,
  Mortality_Rate = sapply(age_groups, function(group) {
    df_age_group <- cleaned_covid_data %>% filter(age_group == group)
    calc_mortality_rate_age(df_age_group, "age_group")
  })
)

# Step 3: Plot Age Group vs Mortality Rate as a bar chart
ggplot(mortality_by_age_group, aes(x = Age_Group, y = Mortality_Rate)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Mortality Rate by Age Group",
       x = "Age Group",
       y = "Mortality Rate (%)") +
  theme_minimal() +
  ylim(0, 15) +  # Set y-axis limits to 0-15 for percentage
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

```

```{r}
#| label: fig-agegrouphospitalisation
#| fig-cap: "Hospitalisation, Intubation, ICU Admission Rate by Age"
#| fig.width: 5
#| fig.height: 3
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"


# Step 1: Define a function to calculate rates for each condition (hospitalization, intubation, ICU)
calc_condition_rate <- function(df, condition_col) {
  total_patients <- nrow(df %>% filter(!is.na(!!sym(condition_col))))  # Non-missing values for the condition
  condition_patients <- nrow(df %>% filter(!!sym(condition_col) == "Yes"))
  if (total_patients > 0) {
    return(condition_patients / total_patients * 100)  # Return rate as a percentage
  } else {
    return(NA)  # Return NA if no patients in the group
  }
}

# Step 2: Calculate the rates for hospitalization, intubation, and ICU admission by age group
age_groups <- c("19 and younger", "20 to 29 Years", "30 to 39 Years", 
                "40 to 49 Years", "50 to 59 Years", "60 to 69 Years", 
                "70 to 79 Years", "80 to 89 Years", "90 and older")

hospitalisation_data <- data.frame(
  Age_Group = age_groups,
  Hospitalization_Rate = sapply(age_groups, function(group) {
    df_age_group <- cleaned_covid_data %>% filter(age_group == group)
    calc_condition_rate(df_age_group, "ever_hospitalized")
  }),
  Intubation_Rate = sapply(age_groups, function(group) {
    df_age_group <- cleaned_covid_data %>% filter(age_group == group)
    calc_condition_rate(df_age_group, "ever_intubated")
  }),
  ICU_Rate = sapply(age_groups, function(group) {
    df_age_group <- cleaned_covid_data %>% filter(age_group == group)
    calc_condition_rate(df_age_group, "ever_in_icu")
  })
)

# Step 3: Reshape the data to long format for grouped bar plot
long_hosp_data <- hospitalisation_data %>%
  pivot_longer(cols = c(Hospitalization_Rate, Intubation_Rate, ICU_Rate),
               names_to = "Condition",
               values_to = "Rate")

# Step 4: Plot Age Group vs Chance of Hospitaliation, Intubation, or ICU as a grouped bar chart
ggplot(long_hosp_data, aes(x = Age_Group, y = Rate, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Hospitalisation, Intubation, ICU Admission Rate by Age",
       x = "Age Group",
       y = "Percentage (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),        # Reduce the title font size
    axis.title.x = element_text(size = 10),      # Reduce the x-axis title font size
    axis.title.y = element_text(size = 10),      # Reduce the y-axis title font size
    axis.text.x = element_text(size = 8),        # Reduce the x-axis text (labels) font size
    axis.text.y = element_text(size = 8),        # Reduce the y-axis text (labels) font size
    legend.title = element_text(size = 8),       # Reduce the legend title font size
    legend.text = element_text(size = 6)         # Reduce the legend text font size
  ) +
  ylim(0, 25) +  # Set y-axis limits to 0-100%
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability
```
\newpage

## Gender vs Outcomes

@fig-gendermortality graphs COVID-19 mortality rates by gender. @fig-genderhospitalisation graphs hospitalisation, ICU and/or incubation rates by gender. That is, how likely a person who has contracted COVID-19 is likely to be in any of these conditions, by gender.
```{r}
#| label: fig-gendermortality
#| fig-cap: "COVID-19 Mortality by Gender"
#| fig.width: 5
#| fig.height: 3
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"

# Step 1: Define the calc_mortality_rate function (as used previously)
calc_mortality_rate_gender <- function(df, gender_col) {
  total_patients <- nrow(df %>% filter(!!sym(gender_col) != ""))
  fatal_patients <- nrow(df %>% filter(!!sym(gender_col) != "" & outcome == "FATAL"))
  if (total_patients > 0) {
    return(fatal_patients / total_patients * 100)  # Return mortality rate as percentage
  } else {
    return(NA)  # Return NA if no patients in the group
  }
}

# Step 2: Calculate mortality rate for each gender (MALE, FEMALE, OTHER)
genders <- c("MALE", "FEMALE", "OTHER")

mortality_by_gender <- data.frame(
  Client_Gender = genders,
  Mortality_Rate = sapply(genders, function(gender) {
    df_gender <- cleaned_covid_data %>% filter(client_gender == gender)
    calc_mortality_rate_gender(df_gender, "client_gender")
  })
)

# Step 3: Plot Gender vs Mortality Rate as a bar chart
ggplot(mortality_by_gender, aes(x = Client_Gender, y = Mortality_Rate)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Mortality Rate by Gender",
       x = "Client Gender",
       y = "Mortality Rate (%)") +
  theme_minimal() +
  ylim(0, 2)  # Set y-axis limits to 0-100 for percentage

```

```{r}
#| label: fig-genderhospitalisation
#| fig-cap: "Hospitalisation, ICU, Intubation Rate by Gender"
#| fig.width: 5
#| fig.height: 3
#| fig.align: center
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"
# Step 1: Calculate the rates for hospitalization, intubation, and ICU admission by gender
genders <- c("MALE", "FEMALE", "OTHER")

hospitalization_data_gender <- data.frame(
  Client_Gender = genders,
  Hospitalization_Rate = sapply(genders, function(gender) {
    df_gender <- cleaned_covid_data %>% filter(client_gender == gender)
    calc_condition_rate(df_gender, "ever_hospitalized")
  }),
  Intubation_Rate = sapply(genders, function(gender) {
    df_gender <- cleaned_covid_data %>% filter(client_gender == gender)
    calc_condition_rate(df_gender, "ever_intubated")
  }),
  ICU_Rate = sapply(genders, function(gender) {
    df_gender <- cleaned_covid_data %>% filter(client_gender == gender)
    calc_condition_rate(df_gender, "ever_in_icu")
  })
)

# Step 2: Reshape the data to long format for grouped bar plot
long_data_gender <- hospitalization_data_gender %>%
  pivot_longer(cols = c(Hospitalization_Rate, Intubation_Rate, ICU_Rate),
               names_to = "Condition",
               values_to = "Rate")

# Step 3: Plot Gender vs Chance of Hospitalization, Intubation, or ICU as a grouped bar chart
ggplot(long_data_gender, aes(x = Client_Gender, y = Rate, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Hospitalization, Intubation, or ICU by Gender",
       x = "Gender",
       y = "Percentage (%)") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),        # Reduce the title font size
    axis.title.x = element_text(size = 10),      # Reduce the x-axis title font size
    axis.title.y = element_text(size = 10),      # Reduce the y-axis title font size
    axis.text.x = element_text(size = 8),        # Reduce the x-axis text (labels) font size
    axis.text.y = element_text(size = 8),        # Reduce the y-axis text (labels) font size
    legend.title = element_text(size = 8),       # Reduce the legend title font size
    legend.text = element_text(size = 6)         # Reduce the legend text font size
  ) +
  ylim(0, 10) +  # Set y-axis limits to 0-100%
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))  # Keep x-axis labels horizontal
```
# Discussion {#sec-discussion}

## Effect of Age on Outcomes

Understanding the effect age has on COVID-19 is extremely important both for potential victims and those in charge of policy to put in place correct and appropriate health measures for different ages. 

Looking at @fig-agegroupmortality, we see a clear message - age group and mortality are positively correlated. More specifically, mortality past the ages of 50-59 shoots from under half a percent to 1.72% for 60-69 years of age. This only worsens as individuals get older. For the age groups 70-79 and 80-89, the mortality rate if one contracts COVID-19 shoots to 4.14% and 7.50% respectively. Moreover, those who contract COVID-19 at ages of 90 and above have a mortality rate of almost 10% (9.62%). 

In contrast, those younger than 50 at the time of contraction have mortality rates under 0.5%. In fact, those 19 and younger have a mortality rate of only 0.007%. Clearly, age and mortalty are very strongly correlated. 

Perhaps of more relevance are chances of hospitalisation, admission to the ICU, and intubation. In reference to @fig-agegrouphospitalisation, we see that the older population is much more susceptible to having more severe cases of COVID-19. For all ages above 70, the chance of hospitalisation is above 15%, peaking at 19.46% for 80-89 year olds. Compared to the younger population, this is a stark difference. Those under 30 have hospitalisation rates of under 30%. This increases with age: hospital admission rates for those with COVID-19 is 1.15% for 30-39 year olds, 2.13% for 40-49 year olds, 4.15% for 50-59 year olds, and 8.91% for 60-69 year olds. 

discussion about weaker immune systems with age (bring in some literature review)

## Effect of Gender on Outcomes

Similar to age, understanding differences in outcomes for genders matter greatly to virologists and as a matter of public safety. Looking at @fig-gendermortality, we find that males that contract COVID-19 have a much higher mortality rate when compared to females (1.47% vs 1.06%). According to this data, males who contract COVID-19 are almost 1.4 times more likely to die than females.

Similarly, looking at @fig-genderhospitalisation, we see that males are more likely to be hospitalised, put in the ICU, and intubated. 

discussion about how Covid-19 affects the male body vs female; lit and scientific review; is this a worldwide trend?


## Broader Discussion and Takeaways

Reference the importance of @fig-treatmentoutcomes - those intubated have almost a 50% chance of death. (what?!) 

## Weaknesses and next steps

Measurement weaknesses (stopped collecting data), might be important to look at selection biases (are there more male cases than females? what about Other genders? are they affect results?

\newpage

# LLM Disclosure

ChatGPT Data Analyst was used to generate code and help fix bugs for this assignment. A full LLM Disclosure can be found on the GitHub Repository under "Other - LLM - usage.txt"

# References

